<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Estimate Wizard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const swiper = new Swiper('.swiper', {
                allowTouchMove: false,
            });

            function validateSlide(index) {
                const slide = swiper.slides[index];
                const inputs = slide.querySelectorAll('input, textarea');
                for (const input of inputs) {
                    if (!input.value.trim()) {
                        alert('Please fill out all fields');
                        return false;
                    }
                }
                return true;
            }

            function collectData() {
                const data = {};
                document.querySelectorAll('input, textarea').forEach(el => {
                    data[el.name] = el.value;
                });
                return data;
            }

            function submitData() {
                const payload = collectData();
                document.getElementById('error').classList.add('hidden');
                document.getElementById('loading').classList.remove('hidden'); // show spinner

                fetch('', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                    },
                    body: JSON.stringify(payload),
                })
                .then(resp => {
                    if (!resp.ok) {
                        return resp.json()
                            .catch(() => ({}))
                            .then(data => {
                                const message = data.error || 'Failed to generate estimate.';
                                throw new Error(message);
                            });
                    }
                    return resp.json();
                })
                .then(data => {
                    document.getElementById('loading').classList.add('hidden'); // hide spinner
                    document.querySelector('form').classList.add('hidden');

                    const projection =
                        typeof data.projection === 'string'
                            ? JSON.parse(data.projection)
                            : data.projection;

                    renderResults(projection);
                })
                .catch(err => {
                    document.getElementById('loading').classList.add('hidden');
                    const errorBox = document.getElementById('error');
                    errorBox.textContent = err.message || 'An unexpected error occurred.';
                    errorBox.classList.remove('hidden');
                });
            }

            function renderResults(projection) {
                const revenues = projection.ten_year_revenue;
                const costs = projection.ten_year_cost;
                const netCashFlows = revenues.map((rev, i) => rev - costs[i]);
                const years = Array.from({length: revenues.length}, (_, i) => i + 1);

                // Chart.js
                const ctx = document.getElementById('cashflowChart').getContext('2d');
                new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: years,
                        datasets: [{
                            label: 'Net Cash Flow',
                            data: netCashFlows,
                            backgroundColor: netCashFlows.map(v => v < 0 ? '#dc2626' : '#16a34a')
                        }]
                    },
                    options: {
                        plugins: { legend: { display: false }},
                        scales: {
                            y: { beginAtZero: true }
                        }
                    }
                });

                // Fill table
                const tbody = document.getElementById('cashflowTable');
                tbody.innerHTML = '';
                years.forEach((year, i) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                      <td class="border px-2 py-1">${year}</td>
                      <td class="border px-2 py-1">${revenues[i].toLocaleString()}</td>
                      <td class="border px-2 py-1">${costs[i].toLocaleString()}</td>
                      <td class="border px-2 py-1 ${netCashFlows[i] < 0 ? 'text-red-600' : 'text-green-600'}">
                          ${netCashFlows[i].toLocaleString()}
                      </td>
                    `;
                    tbody.appendChild(row);
                });

                // Add project name + description
                document.getElementById('proj-name').textContent = projection.name;
                document.getElementById('proj-description').textContent = projection.description;
                document.getElementById('results').classList.remove('hidden');
            }

            document.querySelectorAll('[data-next]').forEach(btn => {
                btn.addEventListener('click', () => {
                    if (!validateSlide(swiper.activeIndex)) {
                        return;
                    }
                    if (swiper.activeIndex === swiper.slides.length - 1) {
                        submitData();
                    } else {
                        swiper.slideNext();
                    }
                });
            });
        });
    </script>
</head>
<body class="min-h-screen bg-green-50 p-4">
    <nav class="bg-green-600 p-4 text-white mb-4">
        <a href="/" class="font-bold">Home</a>
    </nav>
    <div class="flex items-center justify-center">
    <!-- Loading Overlay -->
    <div id="loading" class="hidden fixed inset-0 flex flex-col items-center justify-center bg-white bg-opacity-80 z-50">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-green-600"></div>
        <p class="mt-4 text-green-700 font-semibold">Weâ€™re calculating your estimated earnings...</p>
    </div>

    <div id="error" class="hidden text-red-600 mb-4 text-center"></div>

    <!-- Form -->
    <form class="w-full max-w-xl">
        {% csrf_token %}
        <div class="swiper rounded-lg bg-white shadow">
            <div class="swiper-wrapper">
                <div class="swiper-slide p-6 space-y-4">
                    <h1 class="text-xl font-bold">Estimate Your Earnings</h1>
                    <label for="lot_size_acres" class="block text-sm font-medium text-gray-700">Lot size (acres)</label>
                    <input type="number" name="lot_size_acres" class="w-full border p-2" />
                    <label for="address" class="block text-sm font-medium text-gray-700">Address</label>
                    <input type="text" name="address" class="w-full border p-2" />
                    <button type="button" data-next class="mt-4 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Next</button>
                </div>
                <div class="swiper-slide p-6 space-y-4">
                    <h1 class="text-xl font-bold">What's currently on your property?</h1>
                    <textarea name="current_property" class="w-full border p-2" placeholder="Describe what's on your land today - crops, livestock, forest, or unused space..."></textarea>
                    <button type="button" data-next class="mt-4 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Next</button>
                </div>
                <div class="swiper-slide p-6 space-y-4">
                    <h1 class="text-xl font-bold">What's your goal with your property?</h1>
                    <textarea name="property_goal" class="w-full border p-2" placeholder="Do you want to maximize profit, improve soil health, grow specific crops, or something else?"></textarea>
                    <button type="button" data-next class="mt-4 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Next</button>
                </div>
                <div class="swiper-slide p-6 space-y-4">
                    <h1 class="text-xl font-bold">How much time and money are you willing to invest?</h1>
                    <textarea name="investment_commitment" class="w-full border p-2" placeholder="Are you hands-on, hiring help, or looking for low-maintenance options?"></textarea>
                    <button type="button" data-next class="mt-4 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Next</button>
                </div>
                <div class="swiper-slide p-6 space-y-4">
                    <h1 class="text-xl font-bold">Almost ready! Anything you're really excited about? Or even not excited about?</h1>
                    <textarea name="excitement_notes" class="w-full border p-2" placeholder="Share what interests you - like adding trees or growing coffee - and what you'd rather avoid...?"></textarea>
                    <button type="button" data-next class="mt-4 bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">Submit</button>
                </div>
            </div>
        </div>
    </form>

    <!-- Results -->
    <div id="results" class="hidden mt-6 space-y-6 max-w-3xl w-full">
        <h2 id="proj-name" class="text-2xl font-bold text-green-800 text-center"></h2>
        <p id="proj-description" class="text-gray-700 text-center"></p>

        <div class="bg-white p-4 rounded-lg shadow">
            <canvas id="cashflowChart" height="120"></canvas>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full text-sm text-center border border-gray-200">
                <thead class="bg-green-100">
                    <tr>
                        <th class="px-2 py-1 border">Year</th>
                        <th class="px-2 py-1 border">Total Revenue</th>
                        <th class="px-2 py-1 border">Total Costs</th>
                        <th class="px-2 py-1 border">Net Cash Flow</th>
                    </tr>
                </thead>
                <tbody id="cashflowTable"></tbody>
            </table>
        </div>

        <p class="text-center"><a href="{% url 'estimate-wizard' %}" class="underline text-green-600">Make another estimate</a></p>
    </div>
    </div>
</body>
</html>
